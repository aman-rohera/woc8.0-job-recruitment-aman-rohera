{% extends 'base.html' %}

{% block content %}
<style>
    .form-container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .form-box { 
        background: #111; padding: 40px; border-radius: 10px; 
        border: 1px solid #333; 
    }
    .form-box h1 { color: #00ff9d; margin-bottom: 30px; text-align: center; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: #ccc; margin-bottom: 8px; }
    .form-group input, .form-group textarea, .form-group select { 
        width: 100%; padding: 12px; border-radius: 6px; 
        border: 1px solid #444; background: #1a1a1a; color: #fff; 
    }
    .form-group textarea { min-height: 150px; resize: vertical; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
        border-color: #00ff9d; outline: none; 
    }
    .btn-submit { 
        width: 100%; padding: 15px; background: #007bff; color: white; 
        border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; 
        margin-top: 20px;
    }
    .btn-submit:hover { background: #0056b3; }
    .btn-cancel { 
        display: block; text-align: center; color: #888; 
        margin-top: 15px; text-decoration: none; 
    }
</style>

<div class="form-container">
    <div class="form-box">
        <h1>üîÆ {{ action }} Dark Opportunity (Job)</h1>
        
        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="id_title">Role Title (Job Title)</label>
                <input type="text" name="title" id="id_title" value="{{ form.title.value|default:'' }}" required>
            </div>
            
            <div class="form-group">
                <label for="id_description">Grim Details (Description)</label>
                <textarea name="description" id="id_description" required>{{ form.description.value|default:'' }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="id_haunted_ground">Haunted Ground (Location)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" name="haunted_ground" id="id_haunted_ground" value="{{ form.haunted_ground.value|default:'' }}" required style="flex: 1;">
                    <button type="button" id="detect-location-btn" onclick="detectLocation()" style="padding: 12px 18px; background: transparent; border: 2px solid #6b00ff; border-radius: 8px; color: #d600ff; font-weight: bold; cursor: pointer; white-space: nowrap; transition: all 0.3s; box-shadow: 0 0 10px rgba(214, 0, 255, 0.3);" onmouseover="this.style.background='rgba(107, 0, 255, 0.2)'; this.style.boxShadow='0 0 20px rgba(214, 0, 255, 0.6)'; this.style.textShadow='0 0 10px #d600ff';" onmouseout="this.style.background='transparent'; this.style.boxShadow='0 0 10px rgba(214, 0, 255, 0.3)'; this.style.textShadow='none';">
                        üëª Detect
                    </button>
                </div>
                <small id="location-status" style="color: #888; margin-top: 5px; display: block;"></small>
            </div>
            
            <div class="form-group">
                <label for="id_bounty_gold">Bounty (Salary)</label>
                <input type="text" name="bounty_gold" id="id_bounty_gold" value="{{ form.bounty_gold.value|default:'' }}" placeholder="e.g. $50,000 - $70,000" required>
            </div>
            
            <div class="form-group">
                <label for="id_contract_type">Moon Phase (Job Type)</label>
                <select name="contract_type" id="id_contract_type">
                    <option value="full_moon" {% if form.contract_type.value == 'full_moon' %}selected{% endif %}>Full Moon (Full Time)</option>
                    <option value="half_moon" {% if form.contract_type.value == 'half_moon' %}selected{% endif %}>Half Moon (Part Time)</option>
                    <option value="eclipse" {% if form.contract_type.value == 'eclipse' %}selected{% endif %}>Eclipse (Contract)</option>
                </select>
            </div>
            
            <button type="submit" class="btn-submit">{{ action }} Dark Opportunity</button>
        </form>
        
        <a href="{% url 'my_jobs' %}" class="btn-cancel">Cancel Ritual</a>
    </div>
</div>

<script>
// Location Detection Function
function detectLocation() {
    const locationInput = document.getElementById('id_haunted_ground');
    const statusEl = document.getElementById('location-status');
    const btn = document.getElementById('detect-location-btn');
    
    if (!navigator.geolocation) {
        statusEl.style.color = '#ff0055';
        statusEl.textContent = '‚ö†Ô∏è Geolocation not supported by your browser';
        return;
    }
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Detecting...';
    statusEl.style.color = '#ffcc00';
    statusEl.textContent = 'Getting your location...';
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const { latitude, longitude } = position.coords;
            
            try {
                // Use OpenStreetMap Nominatim for reverse geocoding (free)
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`,
                    { headers: { 'Accept-Language': 'en' } }
                );
                const data = await response.json();
                
                // Extract city and state (prioritize city over taluka/county)
                const city = data.address.city || data.address.town || data.address.state_district || data.address.village || '';
                const state = data.address.state || '';
                
                if (city && state) {
                    locationInput.value = `${city}, ${state}`;
                    statusEl.style.color = '#00ff9d';
                    statusEl.textContent = '‚úì Location detected successfully!';
                } else if (city || state) {
                    locationInput.value = city || state;
                    statusEl.style.color = '#00ff9d';
                    statusEl.textContent = '‚úì Location detected!';
                } else {
                    statusEl.style.color = '#ffcc00';
                    statusEl.textContent = '‚ö†Ô∏è Could not determine city name. Please enter manually.';
                }
            } catch (error) {
                statusEl.style.color = '#ff0055';
                statusEl.textContent = '‚ö†Ô∏è Failed to get location name. Please enter manually.';
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üìç Detect';
        },
        (error) => {
            btn.disabled = false;
            btn.innerHTML = 'üìç Detect';
            statusEl.style.color = '#ff0055';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    statusEl.textContent = '‚ö†Ô∏è Location access denied. Please allow location access or enter manually.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    statusEl.textContent = '‚ö†Ô∏è Location unavailable. Please enter manually.';
                    break;
                case error.TIMEOUT:
                    statusEl.textContent = '‚ö†Ô∏è Location request timed out. Try again.';
                    break;
                default:
                    statusEl.textContent = '‚ö†Ô∏è An error occurred. Please enter location manually.';
            }
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
    );
}
</script>
{% endblock %}